# FightSight Project Structure

**Last Updated**: 2025-11-09
**Version**: 0.1.0

## Overview

FightSight is a monorepo-based application using Docker Compose for service orchestration. The architecture follows a microservices pattern with three main services: Web (Next.js), API (Node.js), and CV Service (Python).

---

## Directory Structure

```
fightsight/
├── .bmad-core/                    # BMAD™ Framework (brainstorming & agent tools)
├── .claude/                       # Claude Code configuration
├── agents/                        # BMAD agent definitions
├── teams/                         # BMAD team configurations
├── expansion-packs/               # BMAD expansion packs
│
├── services/                      # Microservices
│   ├── api/                       # Node.js/TypeScript Main API
│   │   ├── src/
│   │   │   ├── index.ts          # Entry point
│   │   │   ├── config/           # Configuration management
│   │   │   ├── controllers/      # Route controllers
│   │   │   ├── services/         # Business logic
│   │   │   │   ├── llm/          # LLM abstraction layer
│   │   │   │   │   ├── base.ts   # Base LLM interface
│   │   │   │   │   ├── claude.ts # Anthropic implementation
│   │   │   │   │   ├── openai.ts # OpenAI implementation
│   │   │   │   │   └── gemini.ts # Google implementation
│   │   │   │   ├── video/        # Video processing
│   │   │   │   ├── analysis/     # Analysis orchestration
│   │   │   │   └── storage/      # File storage service
│   │   │   ├── models/           # Database models (Prisma)
│   │   │   ├── routes/           # Express/Fastify routes
│   │   │   ├── middleware/       # Auth, validation, error handling
│   │   │   ├── jobs/             # Background job processors
│   │   │   │   ├── video-processor.ts
│   │   │   │   └── analysis-job.ts
│   │   │   └── utils/            # Utilities
│   │   ├── prisma/
│   │   │   └── schema.prisma     # Database schema
│   │   ├── tests/
│   │   ├── Dockerfile
│   │   ├── package.json
│   │   └── tsconfig.json
│   │
│   ├── cv-service/                # Python Computer Vision Service
│   │   ├── app/
│   │   │   ├── main.py           # FastAPI entry point
│   │   │   ├── config.py         # Configuration
│   │   │   ├── routers/
│   │   │   │   ├── health.py     # Health check endpoints
│   │   │   │   ├── pose.py       # Pose detection endpoints
│   │   │   │   └── motion.py     # Motion detection endpoints
│   │   │   ├── services/
│   │   │   │   ├── mediapipe_service.py   # MediaPipe wrapper
│   │   │   │   ├── frame_processor.py     # Frame extraction
│   │   │   │   └── motion_detector.py     # Strike candidate detection
│   │   │   ├── models/           # Pydantic models
│   │   │   │   ├── pose.py
│   │   │   │   └── detection.py
│   │   │   └── utils/
│   │   ├── tests/
│   │   ├── Dockerfile
│   │   ├── requirements.txt
│   │   └── pyproject.toml
│   │
│   └── web/                       # Next.js/React Frontend
│       ├── src/
│       │   ├── app/              # Next.js 14 app directory
│       │   │   ├── layout.tsx
│       │   │   ├── page.tsx      # Home page
│       │   │   ├── upload/       # Video upload page
│       │   │   ├── analysis/     # Analysis results pages
│       │   │   └── api/          # API routes (Next.js API)
│       │   ├── components/
│       │   │   ├── ui/           # Shadcn/ui components
│       │   │   ├── video/        # Video player components
│       │   │   ├── analysis/     # Analysis display components
│       │   │   └── layout/       # Layout components
│       │   ├── lib/
│       │   │   ├── api-client.ts # API client
│       │   │   └── utils.ts
│       │   ├── hooks/
│       │   └── types/
│       ├── public/
│       ├── Dockerfile
│       ├── package.json
│       ├── tsconfig.json
│       └── next.config.js
│
├── packages/                      # Shared packages
│   ├── shared-types/              # Shared TypeScript types
│   │   ├── src/
│   │   │   ├── strike.ts         # Strike event types
│   │   │   ├── analysis.ts       # Analysis result types
│   │   │   ├── fighter.ts        # Fighter types
│   │   │   ├── session.ts        # Session types
│   │   │   ├── api.ts            # API request/response types
│   │   │   └── index.ts
│   │   ├── package.json
│   │   └── tsconfig.json
│   │
│   └── config/                    # Shared configuration
│       ├── src/
│       │   ├── constants.ts      # App-wide constants
│       │   ├── llm-config.ts     # LLM configuration
│       │   └── index.ts
│       ├── package.json
│       └── tsconfig.json
│
├── infrastructure/                # Infrastructure configuration
│   ├── postgres/
│   │   ├── init-scripts/
│   │   │   ├── 01-init.sql      # Database initialization
│   │   │   └── 02-schema.sql    # Initial schema (generated by Prisma)
│   │   └── Dockerfile           # Custom postgres image (optional)
│   │
│   ├── redis/
│   │   └── redis.conf           # Redis configuration
│   │
│   └── nginx/                    # Nginx reverse proxy (production)
│       ├── nginx.conf
│       └── Dockerfile
│
├── scripts/                       # Utility scripts
│   ├── setup.sh                  # Initial setup
│   ├── test-all.sh               # Run all tests
│   └── seed-db.sh                # Seed database (TBD)
│
├── docs/                          # Documentation
│   ├── brainstorming-session-results.md
│   ├── analysis-engine-architecture.md
│   ├── project-structure.md      # This file
│   └── architecture/             # Architecture shards (TBD)
│       ├── coding-standards.md
│       ├── tech-stack.md
│       └── source-tree.md
│
├── docker-compose.yml             # Production compose file
├── docker-compose.dev.yml         # Development overrides
├── .env.example                   # Environment template
├── .gitignore
├── package.json                   # Root package (workspace manager)
├── README.md
└── LICENSE
```

---

## Service Responsibilities

### API Service (Node.js/TypeScript)

**Port**: 3000

**Responsibilities**:
- Main application API
- Authentication & authorization
- Video upload handling
- Analysis job orchestration
- Database operations
- LLM integration (classification layer)
- Report generation
- WebSocket notifications

**Key Dependencies**:
- Express or Fastify (web framework)
- Prisma (ORM)
- Bull (job queue)
- ioredis (Redis client)
- @anthropic-ai/sdk (Claude)
- openai (OpenAI)
- @google/generative-ai (Gemini)
- ffmpeg (video processing)

**External Connections**:
- PostgreSQL (database)
- Redis (cache/queue)
- CV Service (HTTP)
- LLM APIs (Anthropic, OpenAI, Google)
- S3 or local storage

---

### CV Service (Python/FastAPI)

**Port**: 8001 (mapped from internal 8000)

**Responsibilities**:
- Pose detection (MediaPipe)
- Frame extraction from video
- Motion analysis
- Strike candidate identification
- Stance detection
- Pre-filtering for LLM analysis

**Key Dependencies**:
- FastAPI (web framework)
- MediaPipe (pose estimation)
- OpenCV (video processing)
- NumPy (numerical operations)
- Uvicorn (ASGI server)

**External Connections**:
- None (stateless service)
- Receives video frames via HTTP
- Returns pose/motion data via HTTP

---

### Web Service (Next.js/React)

**Port**: 3001 (mapped from internal 3000)

**Responsibilities**:
- User interface
- Video upload with client-side clipping
- Analysis result visualization
- Real-time progress updates
- Strike timeline display
- Report viewing

**Key Dependencies**:
- Next.js 14
- React 18
- TypeScript
- TailwindCSS
- Shadcn/ui
- Recharts (data visualization)
- video.js or similar (video player)

**External Connections**:
- API Service (HTTP & WebSocket)

---

### Worker Service (Node.js/TypeScript)

**Port**: None (background process)

**Responsibilities**:
- Process video analysis jobs from queue
- Coordinate CV Service and LLM calls
- Handle long-running tasks
- Retry failed jobs
- Update job status

**Implementation**: Same codebase as API service, different entry point

---

## Shared Packages

### @fightsight/shared-types

TypeScript type definitions shared across services.

**Exports**:
```typescript
// Strike types
export interface StrikeEvent { ... }
export interface Combination { ... }

// Analysis types
export interface AnalysisResult { ... }
export interface AnalysisReport { ... }

// Fighter types
export interface Fighter { ... }
export interface FighterProfile { ... }

// Session types
export interface Session { ... }
export interface SessionMetadata { ... }
```

### @fightsight/config

Shared configuration and constants.

**Exports**:
```typescript
export const LLM_MODELS = { ... }
export const STRIKE_TYPES = { ... }
export const TARGET_ZONES = { ... }
export const OUTCOMES = { ... }
```

---

## Data Flow

### Video Analysis Pipeline

```
1. User uploads video via Web UI
   ↓
2. API receives upload, stores video, creates job
   ↓
3. Worker picks up job from Redis queue
   ↓
4. Worker sends video to CV Service for frame extraction
   ↓
5. CV Service returns frames + pose data + strike candidates
   ↓
6. Worker sends candidate frames to LLM (parallel batches)
   ↓
7. LLM returns strike classifications
   ↓
8. Worker processes classifications, detects combinations
   ↓
9. Worker stores results in PostgreSQL
   ↓
10. Worker generates final report
   ↓
11. Worker notifies user (WebSocket) and marks job complete
   ↓
12. User views results in Web UI
```

---

## Infrastructure Services

### PostgreSQL

**Port**: 5432

**Purpose**: Primary data store

**Stores**:
- User accounts
- Video metadata
- Analysis sessions
- Strike events
- Fighter profiles
- Combinations
- Analysis reports

### Redis

**Port**: 6379

**Purpose**: Cache & job queue

**Uses**:
- Job queue (Bull)
- Session cache
- Rate limiting
- Temporary data

### PgAdmin (Dev only)

**Port**: 5050

**Purpose**: Database administration UI

### Redis Commander (Dev only)

**Port**: 8081

**Purpose**: Redis administration UI

---

## Docker Volumes

### Persistent Volumes

- `postgres_data` - PostgreSQL data
- `redis_data` - Redis persistence
- `uploads` - Uploaded videos (shared between API and Worker)
- `cv_temp` - Temporary CV processing files

### Development Volumes

- Service directories mounted for hot-reload
- `node_modules` excluded via anonymous volumes

---

## Environment Configuration

### Required Variables

```bash
# Database
DATABASE_URL=postgresql://...

# Redis
REDIS_URL=redis://...

# LLM APIs (at least one required)
ANTHROPIC_API_KEY=sk-ant-...
OPENAI_API_KEY=sk-...
GOOGLE_API_KEY=...

# Services
CV_SERVICE_URL=http://cv-service:8000
```

### Optional Variables

```bash
# LLM Selection
PRIMARY_LLM_PROVIDER=anthropic

# Processing Limits
MAX_VIDEO_SIZE_MB=500
MAX_VIDEO_DURATION_SECONDS=360
FRAME_SAMPLING_RATE=2

# Storage
STORAGE_TYPE=local|s3
AWS_S3_BUCKET=...
```

---

## Development Workflow

### Starting Development

```bash
# 1. First time setup
npm run setup

# 2. Start all services
npm run dev

# 3. Access services
# - Web UI: http://localhost:3001
# - API: http://localhost:3000
# - CV Service: http://localhost:8001
# - PgAdmin: http://localhost:5050
```

### Working on Individual Services

```bash
# API
cd services/api
npm install
npm run dev

# CV Service
cd services/cv-service
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --reload

# Web
cd services/web
npm install
npm run dev
```

### Testing

```bash
# All tests
npm run test

# Individual service
cd services/api && npm test
cd services/cv-service && pytest
cd services/web && npm test
```

---

## Next Steps for Implementation

1. **Scaffold API Service** - Create Express/Fastify app with basic routes
2. **Scaffold CV Service** - Create FastAPI app with MediaPipe integration
3. **Scaffold Web Service** - Create Next.js app with upload UI
4. **Define Database Schema** - Create Prisma schema for all entities
5. **Implement LLM Abstraction** - Create model-agnostic LLM service
6. **Build Analysis Pipeline** - Implement end-to-end video processing
7. **Create Frontend Components** - Build analysis visualization UI

---

## References

- [Brainstorming Session Results](./brainstorming-session-results.md)
- [Analysis Engine Architecture](./analysis-engine-architecture.md)
- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [MediaPipe Pose](https://google.github.io/mediapipe/solutions/pose.html)
- [Anthropic Claude API](https://docs.anthropic.com/)

---

**Document Version**: 1.0
**Last Updated**: 2025-11-09
**Maintained By**: Winston (Architect)
